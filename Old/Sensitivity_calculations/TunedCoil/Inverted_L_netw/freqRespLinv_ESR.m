% Calculate an estimated and normalised frequency gain curve by the 
% freqRespLinv_ESR(71.7,57.4e-3,4.8629e-9,4.5584e-8,2e-12,60e6,[9000:10:11000],100,100)
function [gain, R_c1, R_c2] = freqRespLinv_ESR(Rs,L,Cs,C1,C2,Ca,Ra,freqs,Qc1,Qc2)
    s = 1j*2*pi*freqs;
    f0 = (freqs(1)+freqs(end))/2;
    R_c1 = 1/(2*pi*f0*C1*Qc1);
%     Rs_c1 = Rs + R_c1;
    R_c2 = 1/(2*pi*f0*C2*Qc2);
    
% %     Accounting for ERS of capacitors but not for Cs
%     gain = -(C1*Ra.*s.*(C2*R_c2.*s + 1))./(C2*R_c2.*s + C1*Ra.*s + C2*Ra.*s + C1*Rs_c1.*s ...
%         + Ca*Ra.*s + C1*L.*s.^2 + C1*C2*L*R_c2.*s.^3 + C1*C2*L*Ra.*s.^3 + C1*Ca*L*Ra.*s.^3 ...
%         + C1*C2*R_c2*Ra.*s.^2 + C1*C2*R_c2*Rs_c1.*s.^2 + C1*C2*Ra*Rs_c1.*s.^2 + C2*Ca*R_c2*Ra.*s.^2 ...
%         + C1*Ca*Ra*Rs_c1.*s.^2 + C1*C2*Ca*L*R_c2*Ra.*s.^4 + C1*C2*Ca*R_c2*Ra*Rs_c1.*s.^3 + 1);
%     Accounting for Cs
    gain = -(C1*Ra*s.*(C2*R_c2.*s + 1))./(C1*R_c1.*s + C2*R_c2.*s + C1*Ra.*s + C2*Ra.*s + C1*Rs.*s + Ca*Ra.*s ... 
        + Cs*Rs.*s + C1*L.*s.^2 + Cs*L.*s.^2 + C1*C2*L*R_c2.*s.^3 + C1*C2*L*Ra.*s.^3 + C1*Ca*L*Ra.*s.^3 ...
        + C1*Cs*L*R_c1.*s.^3 + C2*Cs*L*R_c2.*s.^3 + C1*Cs*L*Ra.*s.^3 + C2*Cs*L*Ra.*s.^3 + Ca*Cs*L*Ra.*s.^3 ... 
        + C1*C2*R_c1*R_c2.*s.^2 + C1*C2*R_c1*Ra.*s.^2 + C1*C2*R_c2*Ra.*s.^2 + C1*C2*R_c2*Rs.*s.^2 ...
        + C1*C2*Ra*Rs.*s.^2 + C1*Ca*R_c1*Ra.*s.^2 + C2*Ca*R_c2*Ra.*s.^2 + C1*Ca*Ra*Rs.*s.^2 + C1*Cs*R_c1*Rs.*s.^2 ...
        + C2*Cs*R_c2*Rs.*s.^2 + C1*Cs*Ra*Rs.*s.^2 + C2*Cs*Ra*Rs.*s.^2 + Ca*Cs*Ra*Rs.*s.^2 + C1*C2*Ca*L*R_c2*Ra.*s.^4 ...
        + C1*C2*Cs*L*R_c1*R_c2.*s.^4 + C1*C2*Cs*L*R_c1*Ra.*s.^4 + C1*C2*Cs*L*R_c2*Ra.*s.^4 + C1*Ca*Cs*L*R_c1*Ra.*s.^4 ...
        + C2*Ca*Cs*L*R_c2*Ra.*s.^4 + C1*C2*Ca*R_c1*R_c2*Ra.*s.^3 + C1*C2*Ca*R_c2*Ra*Rs.*s.^3 + C1*C2*Cs*R_c1*R_c2*Rs.*s.^3 ...
        + C1*C2*Cs*R_c1*Ra*Rs.*s.^3 + C1*C2*Cs*R_c2*Ra*Rs.*s.^3 + C1*Ca*Cs*R_c1*Ra*Rs.*s.^3 + C2*Ca*Cs*R_c2*Ra*Rs.*s.^3 ...
        + C1*C2*Ca*Cs*L*R_c1*R_c2*Ra.*s.^5 + C1*C2*Ca*Cs*R_c1*R_c2*Ra*Rs.*s.^4 + 1);
% 
%     figure(20)
%     plot(freqs,abs(gain),'r'), grid on, hold on
%     legend('Ideal','ESR accounted')
end